<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mermaid & MQTT Client</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });

    const brokerUrl = "ws://localhost:9001"; // Aanpassen indien nodig
    const topicHighlight = "update/robot_state"; // Highlight klasse naam

    const client = mqtt.connect(brokerUrl);

let diagramData = {
  "classes": ["WallFollow","EnterOpening","TurnRight","TurnLeft","ExitOpening","End"],
  "associations": [["WallFollow","EnterOpening"],["WallFollow","End"],["EnterOpening","TurnRight"],["EnterOpening","TurnLeft"],["TurnRight","ExitOpening"],["TurnLeft","ExitOpening"],["ExitOpening","WallFollow"]],
};
let activeClass = "WallFollow";


    client.on("connect", () => {
      console.log("[DEBUG] Verbonden met MQTT broker");

      client.subscribe(topicClasses, (err) => {
        if (!err) {
          console.log(`[DEBUG] Geabonneerd op ${topicClasses}`);
          client.publish(topicClasses, "REQUEST_UPDATE");
        }
      });

      client.subscribe(topicHighlight, (err) => {
        if (!err) {
          console.log(`[DEBUG] Geabonneerd op ${topicHighlight}`);
          client.publish(topicHighlight, "REQUEST_UPDATE");
        }
      });
    });

    client.on("message", (topic, message) => {
      console.log(`[DEBUG] Bericht ontvangen op ${topic}: ${message.toString()}`);
      try {
        const data = JSON.parse(message.toString());

        if (topic === topicClasses) {
          diagramData = data;
          updateDiagram();
        } else if (topic === topicHighlight) {
          activeClass = data.activeClass || null; // Verwacht: { "activeClass": "ClassName" }
          if (!diagramData.classes.includes(activeClass)) {
            activeClass = null;
          }
          updateDiagram();
        } else {
          console.warn(`[DEBUG] Onbekend topic: ${topic}`);
        }

      } catch (err) {
        console.error("[DEBUG] Fout bij parsen van bericht:", err);
      }
    });

    function updateDiagram() {
      const container = document.getElementById("mermaid-container");
      if (!diagramData) return;

      let diagram = "graph LR\n";
      diagramData.classes.forEach(cls => {
        if (cls === activeClass) {
          diagram += `${cls}(["${cls}"]):::highlight\n`;
        } else {
          diagram += `${cls}(${cls})\n`;
        }
      });
      diagramData.associations.forEach(([c1, c2]) => {
        diagram += `${c1} --> ${c2}\n`;
      });

      container.classList.remove("fade-in");
      container.innerHTML = `<pre class="mermaid">${diagram}</pre>`;

      mermaid.init(undefined, container.querySelector(".mermaid"));
      setTimeout(() => {
        container.classList.add("fade-in");
      }, 10);
    }

    document.addEventListener("DOMContentLoaded", () => {
      updateDiagram();
    });

  </script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.css">

  <style>
    #mermaid-container {
      transition: opacity 0.5s ease;
      opacity: 1;
      min-height: 200px;
    }

    #mermaid-container.fade-in {
      opacity: 1;
    }

    #mermaid-container:not(.fade-in) {
      opacity: 0;
    }

    /* Mermaid custom styling voor highlighten */
    .mermaid .highlight>rect {
      fill: #ffeb3b !important;
      /* Gele kleur */
      stroke: #f57f17 !important;
      stroke-width: 3px;
    }
  </style>
</head>

<body>
  <h1>Mermaid & MQTT Client</h1>
  <div id="mermaid-container" class="fade-in">Loading...</div>
</body>

</html>
