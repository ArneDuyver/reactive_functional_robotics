<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reactive Functional Robotics</title>
    <link rel="icon" type="image/png" href="/static/rfr_logo.png">
    <link rel="shortcut icon" type="image/png" href="/static/rfr_logo.png">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="/static/rfr_logo.png" alt="RFR Logo" class="header-logo">
            <div class="header-content">
                <h1>Reactive Functional Robotics</h1>
            </div>
            <img src="/static/rfr_logo.png" alt="RFR Logo" class="header-logo">
        </div>
        
        <div class="buttons-container">
            <div class="button-row" id="threepenny-buttons">
                <!-- Threepenny buttons will be added here -->
            </div>
            <div class="button-row-right">
                <button class="btn btn-import" id="import-btn" title="Import Project"><i class="fa-solid fa-file-import"></i></button>
                <button class="btn btn-export" id="export-btn" title="Export Project"><i class="fa-solid fa-file-export"></i></button>
                <button class="btn btn-python" id="python-btn" title="Change script path" onclick="change_python_path()"><i class="fa-brands fa-python"></i></button>
                <form target="_blank" action="https://app.diagrams.net/?src=about">
                    <button class="btn drawio-logo" type="submit" value="Go to draw.io" title="Open draw.io">
                        <img src="/static/drawio_logo.png" alt="draw.io" class="drawio-logo-img">
                    </button>
                </form>
                <button class="btn btn-gear" id="settings-btn" title="Open States Folder"><i class="fa-solid fa-file-pen"></i></button>
                <button class="btn btn-upload" id="upload-btn" title="Upload fsm.xml"><i class="fa-solid fa-gear"></i></button>
                <input type="file" id="file-input" accept=".xml" style="display: none;" />
                <input type="file" id="zip-file-input" accept=".zip" style="display: none;" />
            </div>
        </div>
        
        <div class="python-path-container" style="display: none">
            <label for="python-path-input">Simulation Script Path:</label>
            <input type="text" id="python-path-input" class="python-path-input" 
                   placeholder="Enter path to Python script (e.g., C:\path\to\your\script.py)" 
                   value="..\\complete.py">
        </div>
        
        <div class="tabs-container" id="tabs-container">
            <div style="display: flex; justify-items: center; gap: 10px; padding: 10px 20px 0px 10px;">
                <button id="applicationtabs_hide_btn" style="margin-bottom: 10px; padding: 0px; border: 0px; background: #FFFF;" onclick="applicationtabs_hide_btn_clicked()"><i class="fa-solid fa-eye show-hide-hide-btn"></i></button>
                <button id="applicationtabs_show_btn" style="margin-bottom: 10px; padding: 0px; border: 0px; background: #FFFF; display: none;" onclick="applicationtabs_show_btn_clicked()"><i class="fa-solid fa-eye-slash show-hide-show-btn"></i></button>
                <h2 style="flex: 1 1 100%;" class="tabs-container-header">Application Tabs</h2>
            </div>
            <div id="application-tabs" class="tab-content">
                <div id="threepenny-display-messagecollector" class="active tab-pane">
                    <!-- Threepenny display used to display output of message collector-->
                </div>
                <div id="threepenny-display-runner" class="tab-pane">
                    <!-- Threepenny display used to display output of runner-->
                </div>
                
                <div id="threepenny-display-builder" class="tab-pane">
                    <!-- Threepenny display used to display output of fsm builder-->
                </div>
                <div id="threepenny-display-simulation" class="tab-pane">
                    <!-- Threepenny display used to display output of simulation-->
                </div>
            </div>
            <div id="application-tab-buttons" class="tab-buttons">
                <button class="tab-btn active" data-tab="threepenny-display-messagecollector">Msg collector</button>
                <button class="tab-btn " data-tab="threepenny-display-runner">FSM Runner</button>
                <button class="tab-btn" data-tab="threepenny-display-builder">Builder</button>
                <button class="tab-btn" data-tab="threepenny-display-simulation">Simulation</button>
            </div>
        </div>
        
        <div class="mermaid-section" id="mermaid-section">
            <div style="display: flex; justify-items: center; gap: 10px">
                <button id="mermaid_hide_btn" style="margin-bottom: 10px; padding: 0px; border: 0px; background: #FFFF;" onclick="mermaid_hide_btn_clicked()"><i class="fa-solid fa-eye show-hide-hide-btn"></i></button>
                <button id="mermaid_show_btn" style="margin-bottom: 10px; padding: 0px; border: 0px; background: #FFFF; display: none;" onclick="mermaid_show_btn_clicked()"><i class="fa-solid fa-eye-slash show-hide-show-btn"></i></button>
                <h2 style="flex: 1 1 100%;">FSM Live View</h2>
            </div>
            <div style="margin-bottom: 20px;" id="mermaid-container" class="fade-in">Loading...</div>
        </div>
        
        <div class="fsm-messages-section" id="fsm-messages-section">
            <div style="display: flex; justify-items: center; gap: 10px">
                <button id="mqtt_hide_btn" style="margin-bottom: 10px; padding: 0px; border: 0px; background: #FFFF;" onclick="mqtt_hide_btn_clicked()"><i class="fa-solid fa-eye show-hide-hide-btn"></i></button>
                <button id="mqtt_show_btn" style="margin-bottom: 10px; padding: 0px; border: 0px; background: #FFFF; display: none;" onclick="mqtt_show_btn_clicked()"><i class="fa-solid fa-eye-slash show-hide-show-btn"></i></button>
                <h2 style="flex: 1 1 100%;">FSM Messages Monitor</h2>
            </div>
            <div id="refresh-rate-container" class="refresh-rate-container">
                <label for="refresh-rate-input">Refresh Rate:</label>
                <input type="number" id="refresh-rate-input" class="refresh-rate-input" 
                       value="20" min="1" max="10000" step="1">
                <span class="refresh-rate-unit">ms</span>
                <button id="clear-messages-btn" class="clear-messages-btn">Clear</button>
            </div>
            <textarea style="margin-bottom: 20px;" id="fsm-messages-display" class="fsm-messages-display" 
                      readonly placeholder="Waiting for FSM messages on topic 'fsm/toenv'..."></textarea>
        </div>
    </div>
    
    <!-- Load external JS files -->
    <script src="/static/mermaid-mqtt.js"></script>
    <script src="/static/fsm-messages.js"></script>
    <script>
        // Tab switching functionality with multiple initialization attempts
        function setupTabs() {
            console.log('Setting up tabs...');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            console.log('Found', tabButtons.length, 'tab buttons and', tabPanes.length, 'tab panes');
            
            if (tabButtons.length === 0 || tabPanes.length === 0) {
                console.log('Tab elements not found yet, will retry...');
                return false;
            }
            
            tabButtons.forEach((button, index) => {
                console.log('Setting up button', index, 'with data-tab:', button.getAttribute('data-tab'));
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Tab clicked:', this.getAttribute('data-tab'));
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and panes
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding pane
                    this.classList.add('active');
                    const targetPane = document.getElementById(targetTab);
                    if (targetPane) {
                        targetPane.classList.add('active');
                        console.log('Activated tab:', targetTab);
                    } else {
                        console.log('Target pane not found:', targetTab);
                    }
                });
            });
            
            console.log('Tab setup completed successfully');
            return true;
        }
        
        // Try to setup immediately
        console.log('Immediate tab setup attempt...');
        setupTabs();
        
        // Also try when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up tabs...');
            setupTabs();
        });
        
        // And try with a delay in case Threepenny modifies the DOM later
        setTimeout(() => {
            console.log('Delayed tab setup attempt...');
            setupTabs();
        }, 1000);
        
        // Update status time every second
        setInterval(() => {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            const statusTime = document.getElementById('status-time');
            if (statusTime) statusTime.textContent = timeStr;
        }, 1000);
        
        // Upload button functionality - opens config folder
        document.getElementById('upload-btn').addEventListener('click', function() {
            // This will be handled by the Haskell backend to open config folder
            console.log('Opening config folder...');
        });
        
        // Python path localStorage functionality
        function setupPythonPathStorage() {
            const pythonPathInput = document.getElementById('python-path-input');
            const storageKey = 'rfr-python-path';
            
            if (pythonPathInput) {
                // Load saved value from localStorage on page load
                const savedPath = localStorage.getItem(storageKey);
                if (savedPath) {
                    pythonPathInput.value = savedPath;
                    console.log('Loaded Python path from localStorage:', savedPath);
                }
                
                // Save value to localStorage whenever it changes
                pythonPathInput.addEventListener('input', function() {
                    localStorage.setItem(storageKey, this.value);
                    console.log('Saved Python path to localStorage:', this.value);
                });
                
                // Also save on blur (when user clicks away)
                pythonPathInput.addEventListener('blur', function() {
                    localStorage.setItem(storageKey, this.value);
                    console.log('Saved Python path to localStorage (on blur):', this.value);
                });
                
                console.log('Python path localStorage setup completed');
            } else {
                console.log('Python path input not found, will retry...');
                return false;
            }
            return true;
        }
        
        // Setup Python path storage immediately
        setupPythonPathStorage();
        
        // Also try when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setupPythonPathStorage();
        });
        
        // And try with a delay in case the input is added dynamically
        setTimeout(() => {
            setupPythonPathStorage();
        }, 1000);

        function applicationtabs_hide_btn_clicked(){
            document.getElementById("applicationtabs_show_btn").style.display = "";
            document.getElementById("applicationtabs_hide_btn").style.display = "none";
            document.getElementById("application-tabs").style.display = "none";
            document.getElementById("application-tab-buttons").style.display = "none";
        }

        function applicationtabs_show_btn_clicked(){
            document.getElementById("applicationtabs_show_btn").style.display = "none";
            document.getElementById("applicationtabs_hide_btn").style.display = "";
            document.getElementById("application-tabs").style.display = "";
            document.getElementById("application-tab-buttons").style.display = "";
        }

        function mermaid_hide_btn_clicked(){
            document.getElementById("mermaid_show_btn").style.display = "";
            document.getElementById("mermaid_hide_btn").style.display = "none";
            document.getElementById("mermaid-container").style.display = "none";
        }

        function mermaid_show_btn_clicked(){
            document.getElementById("mermaid_show_btn").style.display = "none";
            document.getElementById("mermaid_hide_btn").style.display = "";
            document.getElementById("mermaid-container").style.display = "";
        }

        function mqtt_hide_btn_clicked(){
            document.getElementById("mqtt_show_btn").style.display = "";
            document.getElementById("mqtt_hide_btn").style.display = "none";
            document.getElementById("refresh-rate-container").style.display = "none";
            document.getElementById("fsm-messages-display").style.display = "none";
        }

        function mqtt_show_btn_clicked(){
            document.getElementById("mqtt_show_btn").style.display = "none";
            document.getElementById("mqtt_hide_btn").style.display = "";
            document.getElementById("refresh-rate-container").style.display = "";
            document.getElementById("fsm-messages-display").style.display = "";
        }

        function change_python_path(){
            var currentpath = document.getElementById("python-path-input").value;
            var promptOutput = prompt("You can change the path to the python file here", currentpath);
            if (promptOutput !== null) {
                document.getElementById("python-path-input").value = promptOutput;
                localStorage.setItem('rfr-python-path', promptOutput);
                console.log("Value of python-path-input changed to", document.getElementById("python-path-input").value);
            } else {
                console.log("Changing python path canceled");
            }
        }
        
    </script>
</body>
</html>