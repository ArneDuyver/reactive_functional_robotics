<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reactive Functional Robotics</title>
    <link rel="icon" type="image/png" href="/static/rfr_logo.png">
    <link rel="shortcut icon" type="image/png" href="/static/rfr_logo.png">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <!-- <img src="/static/rfr_logo.png" alt="RFR Logo" class="header-logo"> -->
                <h1>Reactive Functional Robotics</h1>
            </div>
        </div>
        
        <div class="buttons-container">
            <div class="button-row" id="threepenny-buttons">
                <!-- Threepenny buttons will be added here -->
            </div>
            <div class="button-row-right">
                <button class="btn btn-gear" id="settings-btn" title="Open States Folder"><i class="fa-solid fa-file-pen"></i></button>
                <button class="btn btn-upload" id="upload-btn" title="Upload fsm.xml"><i class="fa-solid fa-gear"></i></button>
                <input type="file" id="file-input" accept=".xml" style="display: none;" />
            </div>
        </div>
        
        <div class="python-path-container">
            <label for="python-path-input">Simulation Script Path:</label>
            <input type="text" id="python-path-input" class="python-path-input" 
                   placeholder="Enter path to Python script (e.g., C:\path\to\your\script.py)" 
                   value="C:\turtlebot_sim\main.py">
        </div>
        
        <div class="tabs-container">
            <div class="tab-content">
                <div id="threepenny-display-messagecollector" class="active tab-pane">
                    <!-- Threepenny display used to display output of message collector-->
                </div>
                <div id="threepenny-display-runner" class="tab-pane">
                    <!-- Threepenny display used to display output of runner-->
                </div>
                
                <div id="threepenny-display-builder" class="tab-pane">
                    <!-- Threepenny display used to display output of fsm builder-->
                </div>
                <div id="threepenny-display-simulation" class="tab-pane">
                    <!-- Threepenny display used to display output of simulation-->
                </div>
            </div>
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="threepenny-display-messagecollector">Msg collector</button>
                <button class="tab-btn " data-tab="threepenny-display-runner">FSM Runner</button>
                <button class="tab-btn" data-tab="threepenny-display-builder">Builder</button>
                <button class="tab-btn" data-tab="threepenny-display-simulation">Simulation</button>
            </div>
        </div>
        
        <div class="mermaid-section">
            <h2>FSM live view</h2>
            <div id="mermaid-container" class="fade-in">Loading...</div>
        </div>
    </div>
    
    <!-- Load external JS file for Mermaid + MQTT -->
    <script src="/static/mermaid-mqtt.js"></script>
    <script>
        // Tab switching functionality with multiple initialization attempts
        function setupTabs() {
            console.log('Setting up tabs...');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            console.log('Found', tabButtons.length, 'tab buttons and', tabPanes.length, 'tab panes');
            
            if (tabButtons.length === 0 || tabPanes.length === 0) {
                console.log('Tab elements not found yet, will retry...');
                return false;
            }
            
            tabButtons.forEach((button, index) => {
                console.log('Setting up button', index, 'with data-tab:', button.getAttribute('data-tab'));
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Tab clicked:', this.getAttribute('data-tab'));
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and panes
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding pane
                    this.classList.add('active');
                    const targetPane = document.getElementById(targetTab);
                    if (targetPane) {
                        targetPane.classList.add('active');
                        console.log('Activated tab:', targetTab);
                    } else {
                        console.log('Target pane not found:', targetTab);
                    }
                });
            });
            
            console.log('Tab setup completed successfully');
            return true;
        }
        
        // Try to setup immediately
        console.log('Immediate tab setup attempt...');
        setupTabs();
        
        // Also try when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up tabs...');
            setupTabs();
        });
        
        // And try with a delay in case Threepenny modifies the DOM later
        setTimeout(() => {
            console.log('Delayed tab setup attempt...');
            setupTabs();
        }, 1000);
        
        // Update status time every second
        setInterval(() => {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            const statusTime = document.getElementById('status-time');
            if (statusTime) statusTime.textContent = timeStr;
        }, 1000);
        
        // Upload button functionality - opens config folder
        document.getElementById('upload-btn').addEventListener('click', function() {
            // This will be handled by the Haskell backend to open config folder
            console.log('Opening config folder...');
        });
        
        // Python path localStorage functionality
        function setupPythonPathStorage() {
            const pythonPathInput = document.getElementById('python-path-input');
            const storageKey = 'rfr-python-path';
            
            if (pythonPathInput) {
                // Load saved value from localStorage on page load
                const savedPath = localStorage.getItem(storageKey);
                if (savedPath) {
                    pythonPathInput.value = savedPath;
                    console.log('Loaded Python path from localStorage:', savedPath);
                }
                
                // Save value to localStorage whenever it changes
                pythonPathInput.addEventListener('input', function() {
                    localStorage.setItem(storageKey, this.value);
                    console.log('Saved Python path to localStorage:', this.value);
                });
                
                // Also save on blur (when user clicks away)
                pythonPathInput.addEventListener('blur', function() {
                    localStorage.setItem(storageKey, this.value);
                    console.log('Saved Python path to localStorage (on blur):', this.value);
                });
                
                console.log('Python path localStorage setup completed');
            } else {
                console.log('Python path input not found, will retry...');
                return false;
            }
            return true;
        }
        
        // Setup Python path storage immediately
        setupPythonPathStorage();
        
        // Also try when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setupPythonPathStorage();
        });
        
        // And try with a delay in case the input is added dynamically
        setTimeout(() => {
            setupPythonPathStorage();
        }, 1000);
    </script>
</body>
</html>